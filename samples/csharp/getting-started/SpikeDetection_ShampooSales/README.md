# SpikeDetection of Shampoo sales

| ML.NET version | API type          | Status                        | App Type    | Data type | Scenario            | ML Task                   | Algorithms                  |
|----------------|-------------------|-------------------------------|-------------|-----------|---------------------|---------------------------|-----------------------------|
| v0.12         | Dynamic API | Up-to-date | Console app | .csv files | SpikeDetection of Shampoo sales | Anomaly Detection | IID Spike Detection |

In this introductory sample, you'll see how to use [ML.NET](https://www.microsoft.com/net/learn/apps/machine-learning-and-ai/ml-dotnet) to detect spikes in shampoo sales. In the world of machine learning, this type of task is called TimeSeries Anomaly Detection.

## Problem
We are having data on shampoo sales over 3 years period in which the sales are high and normal. we identify sudden spikes in shampoo sales so that we can use this spiked data to analyze trends in sales of shampoo. 

To solve this problem, we will build an ML model that takes as inputs: 
* Year-Month
* Sales of shampoo over 3 years period

and predicts the spikes in shampoo sales.

## Dataset
The dataset is available at this [DataMart](https://datamarket.com/data/set/22r0/sales-of-shampoo-over-a-three-year-period#!ds=22r0&display=line)

## ML task - Time Series Anomaly Detection
Anomaly detection is the process of detecting outliers in the data. Time Series Anomaly Detection is a new module that's a bit different from the other anomaly detection models. The Time Series Anomaly Detection module is designed for time series data. It's intended to use to analyze trends over time. The algorithm identifies potentially identifies anomalous trends in the time series data. It flags deviations from the trend's direction or magnitude.

## Solution
The data consists of both 'normal' and 'abnormal' categories of prices. To solve this problem, first we will build an ML model by training on 'normal' category of data and generate alert on abnormal data based on prediction score. the alert data is called as anmolie.

The most notable difference compared to supervised classification is that the training data consists of only a single category or class corresponding to normal data. Any labels present in the data are ignored during training. This is in contrast with supervised training where data from both positive and negative classes will be used. The scores generated by the anomaly detectors indicate a measure of distance from the 'normal' category of data. 


### 1. Build model's pipeline

Building a model includes: Building a model includes: 

* Define the data's schema maped to the datasets to load ('shampoo-sales.csv`) with a TextLoader.

* Create an Estimator by choosing a trainer/learning algorithm (such as `DetectIIDSpike`) to train the model with. 

The initial code is similar to the following:


```CSharp
//Create ML Context object
MLContext mlcontext = new MLContext();

// STEP 1: Common data loading configuration
IDataView dataView = mlcontext.Data.LoadFromTextFile<ShampooSalesData>(path: DatasetPath, hasHeader:true, separatorChar:',');

//STEP 2: Set the training algorithm    
var trainingPipeLine = mlcontext.Transforms.DetectIidSpike(outputColumnName: nameof(ShampooSalesPrediction.Prediction), inputColumnName: nameof(ShampooSalesData.numSales),confidence: 95, pvalueHistoryLength: size / 4);
```

### 2. Train model
Training the model is a process of running the chosen algorithm on a training data to tune the parameters of the model. It is implemented in the `Fit()` API.

 To perform training we just call the `Fit()` method while providing the while providing the training dataset (`shampoo-sales.csv` file) in a DataView object.
```CSharp
ITransformer trainedModel = trainingPipeLine.Fit(dataView);
```

### 3. Consume model
We don't have evaulate step in TimeSeries Anomaly detection. We use the trained model to predict the anomalies in the data.  

```CSharp
//Apply data transformation to create predictions.
IDataView transformedData = trainedModel.Transform(dataView);
var predictions = mlcontext.Data.CreateEnumerable<ShampooSalesPrediction>(transformedData, reuseRowObject: false);
          
Console.WriteLine("Alert\tScore\tP-Value");
foreach (var p in predictions)
{
    if (p.Prediction[0] == 1)
    {
        Console.BackgroundColor = ConsoleColor.DarkYellow;
        Console.ForegroundColor = ConsoleColor.Black;
    }
    Console.WriteLine("{0}\t{1:0.00}\t{2:0.00}", p.Prediction[0], p.Prediction[1], p.Prediction[2]);
    Console.ResetColor();
}
    Console.WriteLine("");
}

//sample output
// Prediction column obtained post-transformation.
   // Alert   Score   P-Value   
    //0       122.90  0.13
    //1       336.50  0.00<-- alert is on, predicted spike
    //0       185.90  0.48
    //0       194.30  0.48
    //0       149.50  0.24
    //0       210.10  0.42
    //0       273.30  0.19
    //0       191.40  0.43
    //0       287.00  0.17
    //0       226.00  0.45
    //0       303.60  0.18
    //0       289.90  0.19
    //1       421.60  0.00 <-- alert is on, predicted spike
    //0       264.50  0.47
```


